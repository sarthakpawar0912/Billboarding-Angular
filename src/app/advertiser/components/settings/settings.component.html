<div class="settings-page">
  <div class="page-header">
    <h1>Settings</h1>
    <p>Manage your account and preferences.</p>
  </div>

  <div class="settings-container">
    <!-- Tabs -->
    <div class="settings-tabs">
      <button class="tab-btn" [class.active]="activeTab === 'profile'" (click)="setActiveTab('profile')">
        <span>ðŸ‘¤</span> Profile
      </button>
      <button class="tab-btn" [class.active]="activeTab === 'payment'" (click)="setActiveTab('payment')">
        <span>ðŸ’³</span> Payment Methods
      </button>
      <button class="tab-btn" [class.active]="activeTab === 'notifications'" (click)="setActiveTab('notifications')">
        <span>ðŸ””</span> Notifications
      </button>
      <button class="tab-btn" [class.active]="activeTab === 'security'" (click)="setActiveTab('security')">
        <span>ðŸ”’</span> Security
      </button>
    </div>

    <!-- Tab Content -->
    <div class="settings-content">
      <!-- Profile Tab -->
      @if (activeTab === 'profile') {
        <div class="settings-section">
          <h2>Profile Information</h2>
          <p class="section-desc">Update your personal and company information.</p>

          <!-- Loading State -->
          @if (isLoading) {
            <div class="loading-state">
              <div class="spinner"></div>
              <p>Loading profile...</p>
            </div>
          } @else {
            <!-- Error Message -->
            @if (errorMessage) {
              <div class="alert alert-error">
                {{ errorMessage }}
              </div>
            }

            <!-- Success Message -->
            @if (successMessage) {
              <div class="alert alert-success">
                {{ successMessage }}
              </div>
            }

            <div class="profile-header">
              <div class="avatar-section">
                <div class="avatar-wrapper">
                  <img [src]="logoUrl || (currentUser()?.avatar || 'assets/default-avatar.png')" alt="Profile" class="avatar">
                  @if (isUploadingLogo) {
                    <div class="avatar-loading">
                      <div class="spinner-small"></div>
                    </div>
                  }
                </div>
                <input
                  type="file"
                  id="logoInput"
                  accept="image/*"
                  (change)="onLogoSelected($event)"
                  style="display: none;">
                <button
                  type="button"
                  class="btn btn-outline btn-sm"
                  (click)="triggerLogoUpload()"
                  [disabled]="isUploadingLogo">
                  @if (isUploadingLogo) {
                    Uploading...
                  } @else {
                    Change Photo
                  }
                </button>
              </div>
            </div>

            <form class="settings-form" (ngSubmit)="saveProfile()">
              <div class="form-row">
                <div class="form-group">
                  <label>Full Name</label>
                  <input type="text" [(ngModel)]="profile.fullName" name="fullName" required>
                </div>
                <div class="form-group">
                  <label>Email</label>
                  <input type="email" [(ngModel)]="profile.email" name="email" readonly class="readonly-input">
                </div>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label>Phone Number</label>
                  <input type="tel" [(ngModel)]="profile.phone" name="phone" required>
                </div>
                <div class="form-group">
                  <label>Company Name</label>
                  <input type="text" [(ngModel)]="profile.companyName" name="companyName" placeholder="Optional">
                </div>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label>Industry</label>
                  <select [(ngModel)]="profile.industry" name="industry">
                    <option value="">Select Industry</option>
                    <option value="Retail">Retail</option>
                    <option value="Technology">Technology</option>
                    <option value="Healthcare">Healthcare</option>
                    <option value="Finance">Finance</option>
                    <option value="Education">Education</option>
                    <option value="Real Estate">Real Estate</option>
                    <option value="Food & Beverage">Food & Beverage</option>
                    <option value="Entertainment">Entertainment</option>
                    <option value="Other">Other</option>
                  </select>
                </div>
                <div class="form-group">
                  <label>Website</label>
                  <input type="url" [(ngModel)]="profile.website" name="website" placeholder="https://example.com">
                </div>
              </div>
              <div class="form-actions">
                <button type="submit" class="btn btn-primary" [disabled]="isSaving">
                  @if (isSaving) {
                    <span class="btn-spinner"></span> Saving...
                  } @else {
                    Save Changes
                  }
                </button>
              </div>
            </form>
          }
        </div>
      }

      <!-- Payment Methods Tab -->
      @if (activeTab === 'payment') {
        <div class="settings-section">
          <h2>Payment Methods</h2>
          <p class="section-desc">Manage your payment options for bookings.</p>

          <!-- Loading State -->
          @if (isLoadingPayments) {
            <div class="loading-state">
              <div class="spinner"></div>
              <p>Loading payment methods...</p>
            </div>
          } @else {
            <!-- Error Message -->
            @if (paymentError) {
              <div class="alert alert-error">
                {{ paymentError }}
              </div>
            }

            <!-- Success Message -->
            @if (paymentSuccess) {
              <div class="alert alert-success">
                {{ paymentSuccess }}
              </div>
            }

            <div class="payment-methods">
              @if (paymentMethods.length === 0) {
                <div class="empty-state">
                  <p>No payment methods added yet.</p>
                </div>
              }

              @for (method of paymentMethods; track method.id) {
                <div class="payment-card" [class.default]="method.isDefault">
                  <div class="payment-icon">
                    {{ getPaymentIcon(method.type) }}
                  </div>
                  <div class="payment-info">
                    <h4>{{ method.label }}</h4>
                    <span class="payment-type">{{ method.type }}</span>
                    @if (method.isDefault) {
                      <span class="default-badge">Default</span>
                    }
                  </div>
                  <div class="payment-actions">
                    @if (!method.isDefault) {
                      <button class="btn btn-outline btn-sm" (click)="setDefaultPaymentMethod(method)">Set Default</button>
                    }
                    <button class="btn btn-outline btn-sm btn-danger-outline" (click)="removePaymentMethod(method)">Remove</button>
                  </div>
                </div>
              }
            </div>

            <button class="btn btn-outline add-payment-btn" (click)="openAddPaymentModal()">
              <span>âž•</span> Add Payment Method
            </button>
          }
        </div>

        <!-- Add Payment Method Modal -->
        @if (showAddPaymentModal) {
          <div class="modal-overlay" (click)="closeAddPaymentModal()">
            <div class="modal-content" (click)="$event.stopPropagation()">
              <div class="modal-header">
                <h3>Add Payment Method</h3>
                <button class="modal-close" (click)="closeAddPaymentModal()">&times;</button>
              </div>
              <div class="modal-body">
                @if (paymentError) {
                  <div class="alert alert-error">
                    {{ paymentError }}
                  </div>
                }

                <div class="form-group">
                  <label>Payment Type</label>
                  <select [(ngModel)]="newPaymentType" name="paymentType">
                    <option value="CARD">Credit/Debit Card</option>
                    <option value="UPI">UPI</option>
                    <option value="NET_BANKING">Net Banking</option>
                    <option value="WALLET">Wallet</option>
                  </select>
                </div>

                <div class="form-group">
                  <label>Label</label>
                  <input
                    type="text"
                    [(ngModel)]="newPaymentLabel"
                    name="paymentLabel"
                    placeholder="e.g., Visa ending 4242 or UPI - myid@upi"
                    required>
                  <small class="form-hint">Enter a descriptive name for this payment method</small>
                </div>
              </div>
              <div class="modal-footer">
                <button class="btn btn-outline" (click)="closeAddPaymentModal()" [disabled]="isAddingPayment">Cancel</button>
                <button class="btn btn-primary" (click)="addPaymentMethod()" [disabled]="isAddingPayment || !newPaymentLabel.trim()">
                  @if (isAddingPayment) {
                    <span class="btn-spinner"></span> Adding...
                  } @else {
                    Add Payment Method
                  }
                </button>
              </div>
            </div>
          </div>
        }
      }

      <!-- Notifications Tab -->
      @if (activeTab === 'notifications') {
        <div class="settings-section">
          <h2>Notification Preferences</h2>
          <p class="section-desc">Choose how you want to receive notifications.</p>

          <!-- Loading State -->
          @if (isLoadingNotifications) {
            <div class="loading-state">
              <div class="spinner"></div>
              <p>Loading notification preferences...</p>
            </div>
          } @else {
            <!-- Error Message -->
            @if (notificationError) {
              <div class="alert alert-error">
                {{ notificationError }}
              </div>
            }

            <!-- Success Message -->
            @if (notificationSuccess) {
              <div class="alert alert-success">
                {{ notificationSuccess }}
              </div>
            }

            <div class="notification-group">
              <h3>Notification Channels</h3>
              <div class="toggle-item">
                <div class="toggle-info">
                  <span class="toggle-label">Email Notifications</span>
                  <span class="toggle-desc">Receive notifications via email</span>
                </div>
                <label class="toggle">
                  <input type="checkbox" [(ngModel)]="notifications.emailNotifications" [disabled]="isSavingNotifications">
                  <span class="toggle-slider"></span>
                </label>
              </div>
              <div class="toggle-item">
                <div class="toggle-info">
                  <span class="toggle-label">SMS Notifications</span>
                  <span class="toggle-desc">Receive notifications via SMS</span>
                </div>
                <label class="toggle">
                  <input type="checkbox" [(ngModel)]="notifications.smsNotifications" [disabled]="isSavingNotifications">
                  <span class="toggle-slider"></span>
                </label>
              </div>
            </div>

            <div class="notification-group">
              <h3>Notification Types</h3>
              <div class="toggle-item">
                <div class="toggle-info">
                  <span class="toggle-label">Payment Notifications</span>
                  <span class="toggle-desc">Receive payment confirmations and invoices</span>
                </div>
                <label class="toggle">
                  <input type="checkbox" [(ngModel)]="notifications.paymentNotifications" [disabled]="isSavingNotifications">
                  <span class="toggle-slider"></span>
                </label>
              </div>
              <div class="toggle-item">
                <div class="toggle-info">
                  <span class="toggle-label">Campaign Notifications</span>
                  <span class="toggle-desc">Updates about your advertising campaigns</span>
                </div>
                <label class="toggle">
                  <input type="checkbox" [(ngModel)]="notifications.campaignNotifications" [disabled]="isSavingNotifications">
                  <span class="toggle-slider"></span>
                </label>
              </div>
              <div class="toggle-item">
                <div class="toggle-info">
                  <span class="toggle-label">System Notifications</span>
                  <span class="toggle-desc">Important system updates and announcements</span>
                </div>
                <label class="toggle">
                  <input type="checkbox" [(ngModel)]="notifications.systemNotifications" [disabled]="isSavingNotifications">
                  <span class="toggle-slider"></span>
                </label>
              </div>
            </div>

            <div class="form-actions">
              <button class="btn btn-primary" (click)="saveNotifications()" [disabled]="isSavingNotifications">
                @if (isSavingNotifications) {
                  <span class="btn-spinner"></span> Saving...
                } @else {
                  Save Preferences
                }
              </button>
            </div>
          }
        </div>
      }

      <!-- Security Tab -->
      @if (activeTab === 'security') {
        <div class="settings-section">
          <h2>Security Settings</h2>
          <p class="section-desc">Keep your account secure.</p>

          <!-- Success Message -->
          @if (securitySuccess) {
            <div class="alert alert-success">
              {{ securitySuccess }}
            </div>
          }

          <div class="security-item">
            <div class="security-info">
              <h3>Password</h3>
              <p>Change your account password</p>
            </div>
            <button class="btn btn-outline" (click)="openChangePasswordModal()">Change Password</button>
          </div>

          <!-- Two-Factor Authentication -->
          <div class="twofa-section">
            <app-twofa-settings></app-twofa-settings>
          </div>

          <div class="security-item">
            <div class="security-info">
              <h3>Login History</h3>
              <p>View your recent login activity</p>
            </div>
            <button class="btn btn-outline" (click)="openLoginHistoryModal()">View History</button>
          </div>

          <div class="danger-zone">
            <h3>Danger Zone</h3>
            <p>Permanent actions for your account. This cannot be undone.</p>
            <button class="btn btn-danger" (click)="openDeleteAccountModal()">Delete Account</button>
          </div>
        </div>

        <!-- Change Password Modal -->
        @if (showChangePasswordModal) {
          <div class="modal-overlay" (click)="closeChangePasswordModal()">
            <div class="modal-content" (click)="$event.stopPropagation()">
              <div class="modal-header">
                <h3>Change Password</h3>
                <button class="modal-close" (click)="closeChangePasswordModal()">&times;</button>
              </div>
              <div class="modal-body">
                @if (securityError) {
                  <div class="alert alert-error">
                    {{ securityError }}
                  </div>
                }

                <div class="form-group">
                  <label>Current Password</label>
                  <input
                    type="password"
                    [(ngModel)]="oldPassword"
                    name="oldPassword"
                    placeholder="Enter current password"
                    [disabled]="isChangingPassword"
                    required>
                </div>

                <div class="form-group">
                  <label>New Password</label>
                  <input
                    type="password"
                    [(ngModel)]="newPassword"
                    name="newPassword"
                    placeholder="Enter new password"
                    [disabled]="isChangingPassword"
                    required>
                  <small class="form-hint">Must be at least 6 characters</small>
                </div>

                <div class="form-group">
                  <label>Confirm New Password</label>
                  <input
                    type="password"
                    [(ngModel)]="confirmPassword"
                    name="confirmPassword"
                    placeholder="Confirm new password"
                    [disabled]="isChangingPassword"
                    required>
                </div>
              </div>
              <div class="modal-footer">
                <button class="btn btn-outline" (click)="closeChangePasswordModal()" [disabled]="isChangingPassword">Cancel</button>
                <button class="btn btn-primary" (click)="changePassword()" [disabled]="isChangingPassword || !oldPassword || !newPassword || !confirmPassword">
                  @if (isChangingPassword) {
                    <span class="btn-spinner"></span> Changing...
                  } @else {
                    Change Password
                  }
                </button>
              </div>
            </div>
          </div>
        }

        <!-- Delete Account Modal -->
        @if (showDeleteAccountModal) {
          <div class="modal-overlay" (click)="closeDeleteAccountModal()">
            <div class="modal-content modal-danger" (click)="$event.stopPropagation()">
              <div class="modal-header modal-header-danger">
                <h3>Delete Account</h3>
                <button class="modal-close" (click)="closeDeleteAccountModal()">&times;</button>
              </div>
              <div class="modal-body">
                <div class="delete-warning">
                  <span class="warning-icon">&#9888;</span>
                  <p><strong>Warning:</strong> This action is permanent and cannot be undone.</p>
                </div>

                <p class="delete-info">Deleting your account will:</p>
                <ul class="delete-list">
                  <li>Remove all your profile information</li>
                  <li>Cancel all pending bookings</li>
                  <li>Delete your payment methods</li>
                  <li>Remove all your data permanently</li>
                </ul>

                @if (securityError) {
                  <div class="alert alert-error">
                    {{ securityError }}
                  </div>
                }

                <div class="form-group">
                  <label>Type <strong>DELETE</strong> to confirm</label>
                  <input
                    type="text"
                    [(ngModel)]="deleteConfirmText"
                    name="deleteConfirmText"
                    placeholder="Type DELETE"
                    [disabled]="isDeletingAccount"
                    class="delete-confirm-input">
                </div>
              </div>
              <div class="modal-footer">
                <button class="btn btn-outline" (click)="closeDeleteAccountModal()" [disabled]="isDeletingAccount">Cancel</button>
                <button class="btn btn-danger" (click)="deleteAccount()" [disabled]="isDeletingAccount || deleteConfirmText !== 'DELETE'">
                  @if (isDeletingAccount) {
                    <span class="btn-spinner-danger"></span> Deleting...
                  } @else {
                    Delete My Account
                  }
                </button>
              </div>
            </div>
          </div>
        }

        <!-- Login History Modal -->
        @if (showLoginHistoryModal) {
          <div class="modal-overlay" (click)="closeLoginHistoryModal()">
            <div class="modal-content modal-large" (click)="$event.stopPropagation()">
              <div class="modal-header">
                <h3>Login History</h3>
                <button class="modal-close" (click)="closeLoginHistoryModal()">&times;</button>
              </div>
              <div class="modal-body">
                @if (isLoadingLoginHistory) {
                  <div class="loading-state">
                    <div class="spinner"></div>
                    <p>Loading login history...</p>
                  </div>
                } @else if (loginHistory.length === 0) {
                  <div class="empty-state">
                    <p>No login history available.</p>
                  </div>
                } @else {
                  <div class="login-history-list">
                    @for (entry of loginHistory; track entry.id) {
                      <div class="login-history-item" [class.risky-login]="entry.risky">
                        <div class="login-history-icon">
                          @if (entry.risky) {
                            <span class="status-warning">&#9888;</span>
                          } @else {
                            <span class="status-success">&#10003;</span>
                          }
                        </div>
                        <div class="login-history-details">
                          <div class="login-history-device">
                            <strong>{{ parseUserAgent(entry.userAgent).device }}</strong> - {{ parseUserAgent(entry.userAgent).browser }}
                            @if (entry.risky) {
                              <span class="risky-badge">Unusual Activity</span>
                            }
                          </div>
                          <div class="login-history-meta">
                            <span>IP: {{ entry.ipAddress || entry.ip || 'Unknown' }}</span>
                          </div>
                          <div class="login-history-time">
                            {{ formatLoginTime(entry.loginAt) }}
                          </div>
                        </div>
                      </div>
                    }
                  </div>
                }
              </div>
              <div class="modal-footer">
                <button class="btn btn-outline" (click)="closeLoginHistoryModal()">Close</button>
              </div>
            </div>
          </div>
        }
      }
    </div>
  </div>
</div>
