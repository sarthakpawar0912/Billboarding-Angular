<div class="bank-settings-container">
  <div class="page-header">
    <div class="header-content">
      <div>
        <h2>Bank Account Settings</h2>
        <p class="subtitle">Manage your bank accounts for commission withdrawals</p>
      </div>
      <button
        nz-button
        nzType="primary"
        nzSize="large"
        class="add-btn"
        (click)="openAddModal()"
      >
        <span nz-icon nzType="plus" nzTheme="outline"></span>
        Add Bank Account
      </button>
    </div>
  </div>

  <nz-spin [nzSpinning]="loading()">
    <!-- Info Alert -->
    <nz-alert
      nzType="info"
      nzMessage="Bank Account for Withdrawals"
      nzDescription="Add your bank account details to receive commission withdrawals. For test mode, payouts are simulated instantly."
      [nzShowIcon]="true"
      class="info-alert"
    ></nz-alert>

    <!-- Bank Accounts Card -->
    <nz-card class="bank-accounts-card" nzTitle="Your Bank Accounts">
      @if (bankAccounts().length > 0) {
        <div class="accounts-grid">
          @for (account of bankAccounts(); track account.id) {
            <div class="account-card" [class.primary]="account.isPrimary">
              @if (account.isPrimary) {
                <span class="primary-badge-text">Primary</span>
              }
              <div class="account-header">
                <span nz-icon nzType="bank" nzTheme="outline" class="bank-icon"></span>
                <span class="bank-name">{{ account.bankName || 'Bank Account' }}</span>
              </div>
              <div class="account-details">
                <div class="detail-row">
                  <span class="label">Account Holder:</span>
                  <span class="value">{{ account.accountHolderName }}</span>
                </div>
                <div class="detail-row">
                  <span class="label">Account Number:</span>
                  <span class="value account-number">{{ account.maskedAccountNumber }}</span>
                </div>
                <div class="detail-row">
                  <span class="label">IFSC Code:</span>
                  <span class="value ifsc">{{ account.ifscCode }}</span>
                </div>
                <div class="detail-row">
                  <span class="label">Account Type:</span>
                  <span class="value">{{ account.accountType }}</span>
                </div>
                @if (account.branchName) {
                  <div class="detail-row">
                    <span class="label">Branch:</span>
                    <span class="value">{{ account.branchName }}</span>
                  </div>
                }
              </div>
              <div class="account-status">
                @if (account.isVerified) {
                  <nz-tag nzColor="green">
                    <span nz-icon nzType="check-circle"></span> Verified
                  </nz-tag>
                } @else {
                  <nz-tag nzColor="orange">
                    <span nz-icon nzType="exclamation-circle"></span> Unverified
                  </nz-tag>
                }
              </div>
              <div class="account-actions">
                @if (!account.isPrimary) {
                  <button
                    nz-button
                    nzType="link"
                    nzSize="small"
                    (click)="setPrimary(account.id)"
                  >
                    Set as Primary
                  </button>
                }
                @if (!account.isVerified) {
                  <button
                    nz-button
                    nzType="link"
                    nzSize="small"
                    (click)="verifyAccount(account.id)"
                  >
                    Verify
                  </button>
                }
                <button
                  nz-button
                  nzType="link"
                  nzSize="small"
                  (click)="openEditModal(account)"
                >
                  Edit
                </button>
                @if (!account.isPrimary) {
                  <button
                    nz-button
                    nzType="link"
                    nzDanger
                    nzSize="small"
                    nz-popconfirm
                    nzPopconfirmTitle="Are you sure you want to delete this bank account?"
                    (nzOnConfirm)="deleteAccount(account.id)"
                  >
                    Delete
                  </button>
                }
              </div>
            </div>
          }
        </div>
      } @else {
        <nz-empty
          nzNotFoundContent="No bank accounts added yet. Add a bank account to receive commission withdrawals."
        >
          <ng-template #nzNotFoundFooter>
            <button nz-button nzType="primary" (click)="openAddModal()">
              <span nz-icon nzType="plus"></span> Add Bank Account
            </button>
          </ng-template>
        </nz-empty>
      }
    </nz-card>

    <nz-divider></nz-divider>

    <!-- Payout History Card -->
    <nz-card class="payouts-card" nzTitle="Withdrawal History">
      @if (payouts().length > 0) {
        <nz-table
          #payoutTable
          [nzData]="payouts()"
          [nzPageSize]="10"
          [nzShowPagination]="true"
          nzShowSizeChanger
        >
          <thead>
            <tr>
              <th>Date</th>
              <th>Amount</th>
              <th>Bank Account</th>
              <th>Status</th>
              <th>UTR/Reference</th>
              <th>Notes</th>
            </tr>
          </thead>
          <tbody>
            @for (payout of payoutTable.data; track payout.id) {
              <tr>
                <td>{{ formatDate(payout.initiatedAt) }}</td>
                <td class="amount">{{ formatCurrency(payout.amount) }}</td>
                <td>
                  <span class="bank-info">
                    {{ payout.bankName || 'N/A' }}<br>
                    <small>{{ payout.bankAccountMasked }}</small>
                  </span>
                </td>
                <td>
                  <nz-tag [nzColor]="getPayoutStatusColor(payout.status)">
                    <span nz-icon [nzType]="getPayoutStatusIcon(payout.status)"></span>
                    {{ payout.status }}
                  </nz-tag>
                </td>
                <td>
                  @if (payout.utrNumber) {
                    <span class="utr-number">{{ payout.utrNumber }}</span>
                  } @else {
                    <span class="no-utr">-</span>
                  }
                </td>
                <td>
                  @if (payout.notes) {
                    <span class="notes">{{ payout.notes }}</span>
                  } @else if (payout.failureReason) {
                    <span class="failure-reason">{{ payout.failureReason }}</span>
                  } @else {
                    <span>-</span>
                  }
                </td>
              </tr>
            }
          </tbody>
        </nz-table>
      } @else {
        <nz-empty nzNotFoundContent="No withdrawal history yet. Withdrawals will appear here after you withdraw commission."></nz-empty>
      }
    </nz-card>
  </nz-spin>
</div>

<!-- Add/Edit Bank Account Modal -->
<nz-modal
  [(nzVisible)]="isModalVisible"
  [nzTitle]="isEditMode ? 'Edit Bank Account' : 'Add Bank Account'"
  [nzFooter]="modalFooter"
  (nzOnCancel)="closeModal()"
  [nzWidth]="550"
>
  <ng-container *nzModalContent>
    <form nz-form [formGroup]="bankForm" nzLayout="vertical">
      <nz-form-item>
        <nz-form-label nzRequired>Account Holder Name</nz-form-label>
        <nz-form-control nzErrorTip="Please enter account holder name (min 3 characters)">
          <input
            nz-input
            formControlName="accountHolderName"
            placeholder="Enter account holder name as per bank records"
          />
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label nzRequired>Account Number</nz-form-label>
        <nz-form-control nzErrorTip="Please enter a valid account number (9-18 digits)">
          <input
            nz-input
            formControlName="accountNumber"
            placeholder="Enter bank account number"
            type="password"
          />
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label nzRequired>Confirm Account Number</nz-form-label>
        <nz-form-control [nzErrorTip]="confirmErrorTpl">
          <input
            nz-input
            formControlName="confirmAccountNumber"
            placeholder="Re-enter bank account number"
          />
          <ng-template #confirmErrorTpl>
            @if (bankForm.get('confirmAccountNumber')?.errors?.['required']) {
              Please confirm account number
            } @else if (bankForm.get('confirmAccountNumber')?.errors?.['mismatch']) {
              Account numbers do not match
            }
          </ng-template>
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label nzRequired>IFSC Code</nz-form-label>
        <nz-form-control nzErrorTip="Please enter a valid IFSC code (e.g., SBIN0001234)">
          <input
            nz-input
            formControlName="ifscCode"
            placeholder="e.g., SBIN0001234"
            style="text-transform: uppercase"
          />
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label nzRequired>Bank Name</nz-form-label>
        <nz-form-control nzErrorTip="Please enter bank name">
          <input
            nz-input
            formControlName="bankName"
            placeholder="e.g., State Bank of India"
          />
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label>Branch Name</nz-form-label>
        <nz-form-control>
          <input
            nz-input
            formControlName="branchName"
            placeholder="e.g., Main Branch, Mumbai"
          />
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label nzRequired>Account Type</nz-form-label>
        <nz-form-control>
          <nz-select formControlName="accountType" nzPlaceHolder="Select account type">
            <nz-option nzValue="SAVINGS" nzLabel="Savings Account"></nz-option>
            <nz-option nzValue="CURRENT" nzLabel="Current Account"></nz-option>
          </nz-select>
        </nz-form-control>
      </nz-form-item>
    </form>
  </ng-container>

  <ng-template #modalFooter>
    <button nz-button nzType="default" (click)="closeModal()">Cancel</button>
    <button
      nz-button
      nzType="primary"
      [nzLoading]="isSaving"
      (click)="saveAccount()"
    >
      {{ isEditMode ? 'Update' : 'Add' }} Account
    </button>
  </ng-template>
</nz-modal>
