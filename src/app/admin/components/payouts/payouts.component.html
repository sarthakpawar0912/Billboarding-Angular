<div class="payouts-container">
  <div class="page-header">
    <h2>Owner Payouts</h2>
    <p class="subtitle">Manage and process owner payout requests</p>
  </div>

  <!-- Stats Cards -->
  <div class="stats-row">
    <nz-card class="stat-card pending">
      <nz-statistic
        [nzValue]="pendingCount"
        nzTitle="Pending Requests"
        [nzPrefix]="pendingIcon"
      ></nz-statistic>
      <ng-template #pendingIcon>
        <span nz-icon nzType="clock-circle" nzTheme="outline"></span>
      </ng-template>
    </nz-card>

    <nz-card class="stat-card amount-pending">
      <nz-statistic
        [nzValue]="totalPending"
        nzTitle="Pending Amount"
        [nzPrefix]="rupeeIcon"
        [nzValueStyle]="{ color: '#faad14' }"
      ></nz-statistic>
      <ng-template #rupeeIcon>
        <span>₹</span>
      </ng-template>
    </nz-card>

    <nz-card class="stat-card paid">
      <nz-statistic
        [nzValue]="totalPaid"
        nzTitle="Total Paid"
        [nzPrefix]="checkIcon"
        [nzValueStyle]="{ color: '#52c41a' }"
      ></nz-statistic>
      <ng-template #checkIcon>
        <span>₹</span>
      </ng-template>
    </nz-card>
  </div>

  <!-- Filter -->
  <nz-card class="filter-card">
    <div class="filter-row">
      <span class="filter-label">Filter by Status:</span>
      <nz-select [(ngModel)]="statusFilter" style="width: 200px;">
        <nz-option nzValue="ALL" nzLabel="All Requests"></nz-option>
        <nz-option nzValue="REQUESTED" nzLabel="Pending"></nz-option>
        <nz-option nzValue="PAID" nzLabel="Paid"></nz-option>
        <nz-option nzValue="REJECTED" nzLabel="Rejected"></nz-option>
        <nz-option nzValue="FAILED" nzLabel="Failed"></nz-option>
      </nz-select>
      <button nz-button nzType="default" (click)="loadPayouts()">
        <span nz-icon nzType="reload"></span>
        Refresh
      </button>
    </div>
  </nz-card>

  <!-- Payouts Table -->
  <nz-spin [nzSpinning]="loading()">
    <nz-card class="table-card">
      @if (filteredPayouts.length > 0) {
        <nz-table
          #payoutTable
          [nzData]="filteredPayouts"
          [nzPageSize]="10"
          [nzShowPagination]="true"
          nzShowSizeChanger
        >
          <thead>
            <tr>
              <th>ID</th>
              <th>Owner</th>
              <th>Amount</th>
              <th>Status</th>
              <th>Requested At</th>
              <th>Processed At</th>
              <th nzAlign="center">Actions</th>
            </tr>
          </thead>
          <tbody>
            @for (payout of payoutTable.data; track payout.id) {
              <tr>
                <td>#{{ payout.id }}</td>
                <td>
                  <div class="owner-info">
                    <strong>{{ payout.owner?.name || 'N/A' }}</strong>
                    <small>{{ payout.owner?.email || '' }}</small>
                  </div>
                </td>
                <td>
                  <span class="amount">{{ formatCurrency(payout.amount) }}</span>
                </td>
                <td>
                  <nz-tag [nzColor]="getStatusColor(payout.status)">
                    {{ payout.status }}
                  </nz-tag>
                </td>
                <td>{{ formatDate(payout.createdAt) }}</td>
                <td>
                  @if (payout.processedAt) {
                    {{ formatDate(payout.processedAt) }}
                  } @else {
                    <span class="text-muted">-</span>
                  }
                </td>
                <td nzAlign="center">
                  @if (payout.status === 'REQUESTED') {
                    <button
                      nz-button
                      nzType="primary"
                      nzSize="small"
                      (click)="openApproveModal(payout)"
                      [nzLoading]="processingId() === payout.id"
                    >
                      <span nz-icon nzType="check"></span>
                      Approve
                    </button>
                    <button
                      nz-button
                      nzType="default"
                      nzDanger
                      nzSize="small"
                      (click)="openRejectModal(payout)"
                      [nzLoading]="processingId() === payout.id"
                      style="margin-left: 8px;"
                    >
                      <span nz-icon nzType="close"></span>
                      Reject
                    </button>
                  } @else if (payout.razorpayPayoutId) {
                    <span class="payout-id">{{ payout.razorpayPayoutId }}</span>
                  } @else if (payout.failureReason) {
                    <span class="failure-reason" title="{{ payout.failureReason }}">
                      {{ payout.failureReason | slice:0:30 }}...
                    </span>
                  } @else {
                    <span class="text-muted">-</span>
                  }
                </td>
              </tr>
            }
          </tbody>
        </nz-table>
      } @else {
        <nz-empty nzNotFoundContent="No payout requests found"></nz-empty>
      }
    </nz-card>
  </nz-spin>

  <!-- Approve Modal -->
  <nz-modal
    [(nzVisible)]="approveModalVisible"
    nzTitle="Approve Payout"
    (nzOnCancel)="approveModalVisible.set(false)"
    (nzOnOk)="approvePayout()"
    [nzOkLoading]="processingId() !== null"
    nzOkText="Approve & Pay"
  >
    @if (selectedPayout()) {
      <div class="modal-content">
        <div class="payout-details">
          <p><strong>Owner:</strong> {{ selectedPayout()!.owner?.name }}</p>
          <p><strong>Amount:</strong> {{ formatCurrency(selectedPayout()!.amount) }}</p>
        </div>
        <div class="form-group">
          <label>Fund Account ID (Razorpay)</label>
          <input nz-input [(ngModel)]="fundAccountId" placeholder="fa_xxxxx" />
          <small class="hint">In test mode, any ID will work</small>
        </div>
      </div>
    }
  </nz-modal>

  <!-- Reject Modal -->
  <nz-modal
    [(nzVisible)]="rejectModalVisible"
    nzTitle="Reject Payout"
    (nzOnCancel)="rejectModalVisible.set(false)"
    (nzOnOk)="rejectPayout()"
    [nzOkLoading]="processingId() !== null"
    nzOkText="Reject"
    nzOkDanger
  >
    @if (selectedPayout()) {
      <div class="modal-content">
        <div class="payout-details">
          <p><strong>Owner:</strong> {{ selectedPayout()!.owner?.name }}</p>
          <p><strong>Amount:</strong> {{ formatCurrency(selectedPayout()!.amount) }}</p>
        </div>
        <div class="form-group">
          <label>Rejection Reason (Optional)</label>
          <textarea nz-input [(ngModel)]="rejectReason" placeholder="Enter reason for rejection..." rows="3"></textarea>
        </div>
      </div>
    }
  </nz-modal>
</div>
